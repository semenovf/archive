/**
 * @file cow_ptr.cpp
 * @author wladt
 * @date Nov 22, 2013
 */

#include <cwt/test.hpp>
#include <pfs/bytearray.hpp>
#include <pfs/cow_ptr.hpp>
#include <iostream>

void test()
{
	// Taken from http://en.wikibooks.org/wiki/More_C%2B%2B_Idioms/Copy-on-write
	pfs::cow_ptr<pfs::bytearray> s1(new pfs::bytearray("Hello"));
	char & c = s1->operator[](4);        // Non-const detachment does nothing here
	pfs::cow_ptr<pfs::bytearray> s2(s1); // Lazy-copy, shared state
	c = '!';

	TEST_OK((*s1)[4] == (*s2)[4] && (*s2)[4] == '!');

	std::cout << "s1=" << *s1 << std::endl;

	*s1 = "World";

	std::cout << "s1=" << *s1 << std::endl;
	std::cout << "s2=" << *s2 << std::endl;
}


int main(int argc, char *argv[])
{
    PFS_CHECK_SIZEOF_TYPES;
    PFS_UNUSED2(argc, argv);
	BEGIN_TESTS(1);

	test();

    END_TESTS;
}
